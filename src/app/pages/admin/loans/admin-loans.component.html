<div class="min-h-screen bg-background">
  <main class="container mx-auto px-4 py-8">
    <div class="mb-8 flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-4xl font-bold text-foreground">Loan Management</h1>
        <p class="text-muted-foreground">Manage book borrowing and returns</p>
      </div>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground"
        (click)="openDialog()"
      >
        <lucide-icon name="plus" class="h-4 w-4"></lucide-icon>
        Create Loan
      </button>
    </div>

    <div class="mb-8 rounded-xl border border-border bg-card">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <lucide-icon name="alert-circle" class="h-5 w-5"></lucide-icon>
          Active Loans
        </h2>
        <p class="text-sm text-muted-foreground">Currently borrowed books</p>
      </div>
      <div class="px-6 py-6">
        @if (isLoading()) {
          <div class="flex items-center justify-center py-12">
            <div class="h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>
          </div>
        } @else if (activeLoans().length === 0) {
          <div class="text-center text-muted-foreground">No active loans</div>
        } @else {
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-muted-foreground">
                <tr>
                  <th class="pb-3 font-medium">Member</th>
                  <th class="pb-3 font-medium">Book</th>
                  <th class="pb-3 font-medium">Borrowed</th>
                  <th class="pb-3 font-medium">Due Date</th>
                  <th class="pb-3 font-medium">Status</th>
                  <th class="pb-3 font-medium">Reminder</th>
                  <th class="pb-3 font-medium">Action</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                @for (loan of activeLoans(); track loan._id) {
                  <tr>
                    <td class="py-3">
                      <div class="font-medium">{{ loan.user?.name }}</div>
                      <div class="text-xs text-muted-foreground">{{ loan.user?.email }}</div>
                    </td>
                    <td>
                      <div class="font-medium">{{ loan.book.title }}</div>
                      <div class="text-xs text-muted-foreground">{{ loan.book.author }}</div>
                    </td>
                    <td>{{ formatDate(loan.borrowDate) }}</td>
                    <td>{{ formatDate(loan.dueDate) }}</td>
                    <td>
                      <span class="rounded-full px-3 py-1 text-xs font-semibold" [ngClass]="statusClasses(loan.status)">
                        {{ loan.status === 'OVERDUE' ? 'Overdue' : 'Active' }}
                      </span>
                    </td>
                    <td>
                      @if (loan.status === 'OVERDUE') {
                        <button
                          type="button"
                          class="inline-flex items-center gap-1 rounded-md border border-border px-3 py-1 text-xs font-medium text-foreground hover:bg-muted"
                          [disabled]="loan.reminderSent || remindingLoanId() === loan._id"
                          (click)="sendReminder(loan)"
                        >
                          <lucide-icon name="bell" class="h-3 w-3"></lucide-icon>
                          {{
                            remindingLoanId() === loan._id
                              ? 'Sending…'
                              : loan.reminderSent
                                ? 'Reminder Sent'
                                : 'Send Reminder'
                          }}
                        </button>
                      } @else {
                        <span class="text-xs text-muted-foreground">-</span>
                      }
                    </td>
                    <td>
                      <button
                        type="button"
                        class="inline-flex items-center gap-1 rounded-md bg-primary px-3 py-1 text-xs font-medium text-primary-foreground"
                        (click)="markReturned(loan)"
                      >
                        <lucide-icon name="check-circle" class="h-3 w-3"></lucide-icon>
                        Return
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>
    <div class="rounded-xl border border-border bg-card">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <lucide-icon name="check-circle" class="h-5 w-5"></lucide-icon>
          Loan History
        </h2>
        <p class="text-sm text-muted-foreground">Previously returned books</p>
      </div>
      <div class="px-6 py-6">
        @if (returnedLoans().length === 0) {
          <div class="text-center text-muted-foreground">No returned loans yet</div>
        } @else {
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-muted-foreground">
                <tr>
                  <th class="pb-3 font-medium">Member</th>
                  <th class="pb-3 font-medium">Book</th>
                  <th class="pb-3 font-medium">Borrowed</th>
                  <th class="pb-3 font-medium">Returned</th>
                  <th class="pb-3 font-medium">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                @for (loan of returnedLoans(); track loan._id) {
                  <tr>
                    <td class="py-3">{{ loan.user?.name }}</td>
                    <td>{{ loan.book.title }}</td>
                    <td>{{ formatDate(loan.borrowDate) }}</td>
                    <td>{{ formatDate(loan.returnDate) }}</td>
                    <td>
                      <span class="rounded-full px-3 py-1 text-xs font-semibold" [ngClass]="statusClasses(loan.status)">
                        Returned
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>
  </main>

  @if (dialogOpen()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4">
      <div class="w-full max-w-lg rounded-xl border border-border bg-card shadow-2xl">
        <div class="flex items-center justify-between border-b border-border px-6 py-4">
          <div>
            <h2 class="text-xl font-semibold text-card-foreground">Create New Loan</h2>
            <p class="text-sm text-muted-foreground">Record a new book borrowing</p>
          </div>
          <button type="button" class="text-muted-foreground hover:text-foreground" (click)="closeDialog()">✕</button>
        </div>
        <form class="px-6 py-6 space-y-4" [formGroup]="form" (ngSubmit)="createLoan()">
          <div class="space-y-2">
            <label class="text-sm font-medium">Member *</label>
            <select formControlName="userId" class="w-full rounded-md border border-input bg-background px-3 py-2">
              <option value="" disabled>Select member</option>
              @for (user of users(); track user._id) {
                <option [value]="user._id">{{ user.name }} ({{ user.email }})</option>
              }
            </select>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Book *</label>
            <select formControlName="bookId" class="w-full rounded-md border border-input bg-background px-3 py-2">
              <option value="" disabled>Select book</option>
              @for (book of availableBooks(); track book._id) {
                <option [value]="book._id">{{ book.title }} by {{ book.author }} ({{ book.availableCopies }} available)</option>
              }
            </select>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Due Date *</label>
            <input type="date" formControlName="dueDate" class="w-full rounded-md border border-input bg-background px-3 py-2" />
          </div>
          <div class="flex justify-end gap-3">
            <button type="button" class="rounded-md border border-border px-4 py-2" (click)="closeDialog()">Cancel</button>
            <button type="submit" class="rounded-md bg-primary px-4 py-2 text-primary-foreground" [disabled]="submitting()">
              {{ submitting() ? 'Creating…' : 'Create Loan' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
